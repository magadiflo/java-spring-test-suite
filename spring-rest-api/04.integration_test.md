# Integration Test - Test de Repositorios (`@DataJpaTest`)

---

Los `tests de integraci√≥n` validan que los distintos componentes de la aplicaci√≥n (repositorios, servicios,
controladores, etc.) `interact√∫en correctamente entre s√≠` y con dependencias externas como `bases de datos` o
`servicios`.

En este caso, probaremos la integraci√≥n entre `Spring Data JPA` y una base de datos (primero en memoria con `H2`,
luego `MySQL`).

## ‚öôÔ∏è Configura H2 como base de datos en memoria

En el proyecto `spring-rest-api`, agregamos la dependencia de `H2` en el `pom.xml` con el scope limitado a `test`.

### üì¶ Motivo

Usamos `H2` para ejecutar pruebas r√°pidas en memoria sin depender de una base real. M√°s adelante, reemplazaremos
esta configuraci√≥n por `MySQL` o `Testcontainers`, pero `H2` nos permite practicar el flujo de integraci√≥n sin
sobrecargar el entorno.

````xml

<dependency>
    <groupId>com.h2database</groupId>
    <artifactId>h2</artifactId>
    <scope>test</scope> <!-- Importante: solo se usar√° durante los tests -->
</dependency>
````

üí° Nota profesional:
> Aunque `H2` es muy √∫til en fases iniciales, no siempre refleja el comportamiento exacto de `MySQL` o `PostgreSQL`,
> por lo que en entornos reales se recomienda pasar pronto a `Testcontainers` o bases de datos reales en `Docker`.

### üß± Perfiles para pruebas

En lecciones anteriores definimos un `application.yml` dentro de `/src/test/resources` para aislar la configuraci√≥n
de pruebas del entorno principal (`/src/main/resources`).

Ahora organizaremos nuestros archivos de configuraci√≥n de la siguiente manera:

üìÅ Estructura recomendada

````
src/
‚îú‚îÄ‚îÄ main/
‚îÇ   ‚îî‚îÄ‚îÄ resources/
‚îÇ       ‚îú‚îÄ‚îÄ application.yml
‚îÇ       ‚îú‚îÄ‚îÄ application-dev.yml
‚îÇ       ‚îú‚îÄ‚îÄ application-qa.yml
‚îÇ       ‚îî‚îÄ‚îÄ application-prod.yml
‚îî‚îÄ‚îÄ test/
    ‚îî‚îÄ‚îÄ resources/
        ‚îú‚îÄ‚îÄ application.yml               # Config base com√∫n a todos los tests
        ‚îú‚îÄ‚îÄ application-test.yml          # Perfil de pruebas con MySQL real o contenedores
        ‚îî‚îÄ‚îÄ application-test-h2.yml       # Perfil alternativo con base en memoria H2
````

üß© Prop√≥sito de cada archivo

| Archivo                   | Prop√≥sito                                            | Uso t√≠pico                          |
|---------------------------|------------------------------------------------------|-------------------------------------|
| `application.yml`         | Configuraci√≥n base (nombre app, logs, perfil activo) | Se carga en todos los tests         |
| `application-test.yml`    | Configuraci√≥n de pruebas con MySQL o Testcontainers  | Ideal para CI/CD o integraci√≥n real |
| `application-test-h2.yml` | Configuraci√≥n ligera con H2                          | Ideal para pruebas locales r√°pidas  |

### ‚öôÔ∏è Configuraci√≥n base (`application.yml`)

Ubicaci√≥n: `/src/test/resources/application.yml`

````yml
spring:
  application:
    name: spring-rest-api
  profiles:
    active: test-h2 # Activamos por defecto el perfil de H2 para pruebas locales

logging:
  level:
    root: WARN
    dev.magadiflo.app: DEBUG
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE
````

üß† Explicaci√≥n de configuraci√≥n

- `root: WARN` ‚Üí Reduce el ruido en consola; solo se muestran advertencias o errores globales.
- `dev.magadiflo.app: DEBUG` ‚Üí Habilita logs detallados para tus clases.
- `org.hibernate.SQL: DEBUG` ‚Üí Muestra las sentencias SQL generadas.
- `org.hibernate.type.descriptor.sql.BasicBinder: TRACE` ‚Üí Muestra los valores de los par√°metros enviados al SQL.

üí° Recomendaci√≥n:
> Estos niveles de log son muy √∫tiles en etapa de pruebas, pero en producci√≥n deben reducirse a `INFO` o `WARN`
> para evitar sobrecargar los logs.

### ‚öôÔ∏è Configuraci√≥n del perfil `test-h2`

Ubicaci√≥n: `/src/test/resources/application-test-h2.yml`

````yml
server:
  port: 0  # Usa un puerto aleatorio para evitar conflictos con la aplicaci√≥n real

spring:
  datasource:
    url: jdbc:h2:mem:db_test_h2;DB_CLOSE_ON_EXIT=FALSE;DB_CLOSE_DELAY=-1;MODE=MySQL
    username: h2_user
    password: h2_pass
  jpa:
    hibernate:
      ddl-auto: create-drop  # Crea y destruye el esquema por cada suite de tests
    properties:
      hibernate:
        format_sql: true
        use_sql_comments: false
  h2:
    console:
      enabled: true
````

üîç Detalle de propiedades clave

- `spring.datasource.url`
    - `jdbc:h2:mem:db_test_h2` ‚Üí base de datos en memoria (no persiste en disco).
    - `DB_CLOSE_ON_EXIT=FALSE` ‚Üí evita el cierre autom√°tico al terminar la JVM.
    - `DB_CLOSE_DELAY=-1` ‚Üí mantiene viva la base incluso sin conexiones activas.
    - `MODE=MySQL` ‚Üí hace que `H2 `interprete la sintaxis SQL como `MySQL` (√∫til para dialectos y queries nativos).
- `spring.datasource.username/password`: define credenciales de acceso al motor `H2`. Para entrar por navegador a la
  consola `H2`, necesitamos:
    - Activar la consola con `spring.h2.console.enabled=true`
    - Acceder v√≠a `http://localhost:{puerto}/h2-console`
    - Usar el mismo `jdbc:h2:mem:db_test_h2` como `URL`
- `ddl-auto: create-drop` ‚Üí crea el esquema al iniciar los tests y lo destruye al finalizar. Ideal para aislar las
  pruebas.
- `format_sql: true` ‚Üí formatea las sentencias SQL en el log, lo que facilita su lectura.

### üß† Sobre la autoconfiguraci√≥n de H2

Spring Boot detecta autom√°ticamente la dependencia `com.h2database:h2` y configura un datasource por defecto,
por lo que no es necesario definir manualmente la URL ni el driver.

Sin embargo, en entornos profesionales `s√≠ se suele personalizar` la configuraci√≥n para:

- Asignar nombres de base de datos espec√≠ficos.
- Controlar el cierre del contexto.
- Emular el comportamiento de `MySQL` (con `MODE=MySQL`).

üß© Conclusi√≥n:

- Si solo usamos `H2` para pruebas b√°sicas, basta con la dependencia.
- Pero para escenarios m√°s realistas (emulaci√≥n de MySQL, logs SQL, control de ciclo de vida), la configuraci√≥n
  personalizada es una buena pr√°ctica.
